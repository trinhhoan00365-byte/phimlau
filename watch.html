export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    /* =========================
       CORS PREFLIGHT
       ========================= */
    if (request.method === "OPTIONS") {
      return new Response(null, { headers: cors() });
    }

    /* =========================
       PAGINATION
       /page/2 -> /index.html?page=2
       ========================= */
    const pageMatch = url.pathname.match(/^\/page\/(\d+)\/?$/);
    if (pageMatch) {
      url.pathname = "/index.html";
      url.searchParams.set("page", pageMatch[1]);
      return fetch(url.toString(), request);
    }

    /* =========================
       VIDEO SLUG ROUTE
       /video/slug--id -> /watch.html
       ⚠️ KHÔNG truyền slug qua query
       ========================= */
    const videoMatch = url.pathname.match(/^\/video\/([^\/]+)$/);
    if (videoMatch) {
      url.pathname = "/watch.html";
      return fetch(url.toString(), request);
    }

    /* =========================
       GET VIDEO LIST
       ========================= */
    if (url.pathname === "/videos") {
      const list = await env.VIDEOS.get("list");
      return json(list ? JSON.parse(list) : []);
    }

    /* =========================
       ADD VIDEO
       ========================= */
    if (url.pathname === "/admin/add" && request.method === "POST") {
      const { password, video } = await request.json();
      if (password !== "11111") return json({ error: "Unauthorized" }, 401);

      const list = JSON.parse(await env.VIDEOS.get("list") || "[]");

      // ID luôn là string
      video.id = Date.now().toString();

      // Tạo slug tự động nếu chưa có
      if (!video.slug && video.title) {
        const baseSlug = video.title
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

        video.slug = `${baseSlug}--${video.id}`;
      }

      list.unshift(video);
      await env.VIDEOS.put("list", JSON.stringify(list));
      return json({ success: true });
    }

    /* =========================
       EDIT VIDEO
       (KHÔNG tự đổi slug)
       ========================= */
    if (url.pathname === "/admin/edit" && request.method === "POST") {
      const { password, video } = await request.json();
      if (password !== "11111") return json({ error: "Unauthorized" }, 401);

      const list = JSON.parse(await env.VIDEOS.get("list") || "[]");
      const idx = list.findIndex(v => String(v.id) === String(video.id));
      if (idx === -1) return json({ error: "Not found" }, 404);

      list[idx] = { ...list[idx], ...video };
      await env.VIDEOS.put("list", JSON.stringify(list));
      return json({ success: true });
    }

    /* =========================
       DELETE VIDEO
       ========================= */
    if (url.pathname === "/admin/delete" && request.method === "POST") {
      const { password, id } = await request.json();
      if (password !== "11111") return json({ error: "Unauthorized" }, 401);

      let list = JSON.parse(await env.VIDEOS.get("list") || "[]");
      list = list.filter(v => String(v.id) !== String(id));

      await env.VIDEOS.put("list", JSON.stringify(list));
      return json({ success: true });
    }

    /* =========================
       VIEW COUNT
       KEY = slug--id
       ========================= */
    if (url.pathname === "/view") {
      const slug = url.searchParams.get("slug");
      const inc = url.searchParams.get("inc");

      if (!slug) return json({ views: 0 });

      const key = "view:" + slug;
      let views = Number(await env.VIEWS.get(key) || 0);

      if (inc === "1") {
        views++;
        await env.VIEWS.put(key, views.toString());
      }

      return json({ views });
    }

    return new Response("Not found", { status: 404 });
  }
};

/* =========================
   HELPERS
   ========================= */
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      ...cors(),
      "Content-Type": "application/json"
    }
  });
}

function cors() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type"
  };
}
